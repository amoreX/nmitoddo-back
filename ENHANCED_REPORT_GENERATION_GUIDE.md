# Enhanced Manufacturing Report Generation API

## Overview

The new report generation system provides comprehensive manufacturing reports with PDF output. It includes authentication, authorization, data aggregation, KPI calculation, and styled PDF generation with charts and tables.

## Features

✅ **Authentication & Authorization**: Bearer token authentication with role-based access (admin/manager only)
✅ **Data Collection**: Comprehensive data aggregation from all Prisma models
✅ **KPI Calculation**: Manufacturing orders, work orders, productivity, costs, and inventory metrics
✅ **PDF Generation**: HTML templates with Chart.js integration converted to PDF using Puppeteer
✅ **Report Storage**: Automatic saving of reports and PDF data to database
✅ **Auto-Download**: Direct PDF file download in browser/Postman

## API Endpoint

### POST `/api/reports/generate`

Generates a comprehensive manufacturing report with PDF output.

#### Authentication
- **Required**: Bearer token in Authorization header
- **Roles**: Only `admin` and `manager` roles can generate reports
- **Header**: `Authorization: Bearer <your-jwt-token>`

#### Request Body

```json
{
  "reportType": "daily" | "weekly" | "monthly" | "quarterly" | "yearly",
  "params": {
    "dateFrom": "2024-01-01",  // Optional: Custom start date (ISO format)
    "dateTo": "2024-01-31"     // Optional: Custom end date (ISO format)
  }
}
```

#### Response

- **Content-Type**: `application/pdf`
- **Content-Disposition**: `attachment; filename="report_<type>_<timestamp>.pdf"`
- **Body**: PDF file buffer (auto-downloads in browser/Postman)

#### Report Types

1. **daily**: Current day or custom date range
2. **weekly**: Current week
3. **monthly**: Current month
4. **quarterly**: Current quarter
5. **yearly**: Current year

## Report Contents

### 1. Cover Page
- Company branding
- Report title and type
- Generation period
- Generated by and timestamp

### 2. Executive Summary
- Total manufacturing orders, work orders, products, users
- Key performance indicators (KPIs)
- Completion rates and lead times
- Visual charts (status breakdown, utilization, trends)

### 3. Manufacturing Orders
- Status breakdown with percentages
- Top products by order volume
- Delayed orders with days past due

### 4. Work Centers & Inventory
- Work center utilization and costs
- Current stock levels with low stock alerts
- Key insights and recommendations

### 5. Interactive Charts
- Manufacturing order status pie chart
- Work center utilization bar chart
- Daily orders trend line chart

## Data Sources

The system queries the following Prisma models:

- **ManufacturingOrder**: Order counts, status, lead times
- **WorkOrder**: Work completion rates, durations
- **WorkCenter**: Utilization, costs, capacity
- **ProductLedger**: Inventory movements
- **ProductStock**: Current stock levels
- **Product**: Product information
- **User**: User assignments and roles

## KPIs Calculated

### Manufacturing Orders
- Total orders by status (draft, confirmed, in_progress, to_close, done, cancelled)
- Completion rates
- Average lead times

### Work Orders
- Total work orders by status (to_do, started, paused, completed)
- Completion percentage

### Productivity
- Orders per day
- Overall completion rate

### Inventory
- Total movements (in/out)
- Low stock item alerts
- Inventory efficiency ratios

### Costs
- Total work center costs
- Average cost per order
- Work center utilization rates

## Error Handling

### 401 Unauthorized
```json
{
  "success": false,
  "message": "Access denied. No token provided."
}
```

### 403 Forbidden
```json
{
  "success": false,
  "message": "Access denied. Only admin and manager roles can generate reports."
}
```

### 400 Bad Request
```json
{
  "success": false,
  "message": "Invalid report type. Must be one of: daily, weekly, monthly, quarterly, yearly"
}
```

### 500 Internal Server Error
```json
{
  "success": false,
  "message": "Failed to generate report",
  "error": "Error details (in development mode)"
}
```

## Usage Examples

### 1. Generate Daily Report (Current Day)
```bash
curl -X POST http://localhost:3000/api/reports/generate \\
  -H "Authorization: Bearer your-jwt-token" \\
  -H "Content-Type: application/json" \\
  -d '{"reportType": "daily"}' \\
  --output daily_report.pdf
```

### 2. Generate Monthly Report with Custom Date Range
```bash
curl -X POST http://localhost:3000/api/reports/generate \\
  -H "Authorization: Bearer your-jwt-token" \\
  -H "Content-Type: application/json" \\
  -d '{
    "reportType": "monthly",
    "params": {
      "dateFrom": "2024-01-01",
      "dateTo": "2024-01-31"
    }
  }' \\
  --output january_report.pdf
```

### 3. Postman Usage
1. Import the provided Postman collection: `REPORT_GENERATION_POSTMAN_COLLECTION.json`
2. Set your Bearer token in the Authorization header
3. Select "Send and Download" to automatically save the PDF

## Technical Architecture

### Controllers
- `newReportController.ts`: Main controller with authentication and report generation logic

### Services
- `htmlPdfService.ts`: HTML template generation and PDF conversion using Puppeteer

### Routes
- `newReportRoutes.ts`: Express routes with authentication middleware

### Authentication Flow
1. Extract Bearer token from Authorization header
2. Verify JWT token and get user ID
3. Fetch user from database and check role
4. Allow only admin/manager roles to proceed

### Data Collection Flow
1. Calculate date range based on report type and optional params
2. Query all relevant Prisma models within date range
3. Calculate KPIs and aggregate metrics
4. Build comprehensive report data structure

### PDF Generation Flow
1. Generate HTML template with Chart.js integration
2. Use Puppeteer to render HTML in headless browser
3. Wait for Chart.js to render all charts
4. Convert to PDF with proper styling and page breaks
5. Return PDF buffer for download

### Report Storage
```javascript
await prisma.report.create({
  data: {
    reportType,
    data: {
      aggregated: reportData,
      pdfBase64: pdfBuffer.toString('base64')
    },
    userId
  }
});
```

## Dependencies

- **puppeteer**: HTML to PDF conversion
- **moment**: Date manipulation and formatting
- **@prisma/client**: Database ORM
- **express**: Web framework
- **jsonwebtoken**: JWT authentication

## Testing

Use the provided Postman collection to test all endpoints:

1. **Valid requests**: Test each report type with proper authentication
2. **Authentication**: Test without token (should return 401)
3. **Authorization**: Test with regular user token (should return 403)
4. **Validation**: Test with invalid report type (should return 400)
5. **Custom dates**: Test with custom date ranges

## Performance Considerations

- **Puppeteer**: Launches headless browser for PDF generation (can be memory intensive)
- **Database queries**: Optimized with appropriate includes and filtering
- **Chart rendering**: 2-second wait time for Chart.js to render properly
- **Large datasets**: Consider pagination for very large date ranges

## Future Enhancements

- Report scheduling and email delivery
- Custom report templates
- Real-time chart updates
- Export to multiple formats (Excel, CSV)
- Report caching for frequently requested reports
- Advanced filtering options (by product, work center, user)

## Troubleshooting

### Common Issues

1. **PDF generation fails**: Check Puppeteer installation and system dependencies
2. **Charts not rendering**: Ensure adequate wait time for Chart.js loading
3. **Authentication errors**: Verify JWT token and user roles in database
4. **Large file downloads**: Increase request timeout for complex reports

### Debug Mode

Set `NODE_ENV=development` to get detailed error messages in API responses.

### Logs

Monitor server logs for detailed request/response information and error stack traces.

## Security Notes

- Reports may contain sensitive manufacturing data
- Access is restricted to admin/manager roles only
- JWT tokens should be properly secured and have appropriate expiration
- Consider rate limiting for report generation to prevent abuse
- PDF files are temporarily stored in database - consider cleanup policies